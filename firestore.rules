rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    match /customers/{customerId} {
      // Anyone can create, read, and list customers for the admin panel.
      // Security is handled by the secret URL.
      allow read, list, create: if true;
      // No updates or deletes allowed from the client.
      allow update, delete: if false;
    }

    match /access_codes/{accessCodeId} {
      // Anyone can create codes (via the admin panel).
      allow create: if true;
      
      // Anyone can read a code to validate it.
      allow read, list: if true;
      
      // A user can update a code ONLY to mark it as used.
      // This is the core of the single-use logic.
      // 1. The code must not have been used before (isUsed is false).
      // 2. The update can only change isUsed to true.
      // 3. No other fields can be changed except for usedAt.
      allow update: if request.resource.data.isUsed == true &&
                       resource.data.isUsed == false &&
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isUsed', 'usedAt']);
                       
      // Deletes are disallowed from client.
      allow delete: if false;
    }
  }
}
